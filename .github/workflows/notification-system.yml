name: Notification System

on:
  workflow_run:
    workflows:
      - "Commit Verification"
      - "Integrity Check"
      - "Code Integrity"
    types:
      - completed

jobs:
  notify-on-failure:
    name: Send Failure Notifications
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: Determine severity level
        id: severity
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          
          case "$WORKFLOW_NAME" in
            "Commit Verification")
              echo "level=CRITICAL" >> $GITHUB_OUTPUT
              echo "priority=1" >> $GITHUB_OUTPUT
              ;;
            "Integrity Check")
              echo "level=HIGH" >> $GITHUB_OUTPUT
              echo "priority=2" >> $GITHUB_OUTPUT
              ;;
            "Code Integrity")
              echo "level=MEDIUM" >> $GITHUB_OUTPUT
              echo "priority=3" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "level=LOW" >> $GITHUB_OUTPUT
              echo "priority=4" >> $GITHUB_OUTPUT
              ;;
          esac
          
      - name: Create notification payload
        id: payload
        run: |
          cat > notification.json << EOF
          {
            "workflow": "${{ github.event.workflow_run.name }}",
            "status": "${{ github.event.workflow_run.conclusion }}",
            "severity": "${{ steps.severity.outputs.level }}",
            "priority": ${{ steps.severity.outputs.priority }},
            "repository": "${{ github.repository }}",
            "branch": "${{ github.event.workflow_run.head_branch }}",
            "commit": "${{ github.event.workflow_run.head_sha }}",
            "actor": "${{ github.event.workflow_run.actor.login }}",
            "run_url": "${{ github.event.workflow_run.html_url }}",
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          cat notification.json
          
      - name: Send GitHub notification
        run: |
          echo "ðŸ“¢ Sending GitHub notification..."
          echo "Severity: ${{ steps.severity.outputs.level }}"
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Status: FAILED"
          echo "View details: ${{ github.event.workflow_run.html_url }}"
          
      - name: Create issue for critical failures
        if: steps.severity.outputs.level == 'CRITICAL'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ CRITICAL: ${context.payload.workflow_run.name} Failed`,
              body: `## Critical Verification Failure\n\n` +
                    `**Workflow:** ${context.payload.workflow_run.name}\n` +
                    `**Status:** ${context.payload.workflow_run.conclusion}\n` +
                    `**Branch:** ${context.payload.workflow_run.head_branch}\n` +
                    `**Commit:** ${context.payload.workflow_run.head_sha}\n` +
                    `**Actor:** @${context.payload.workflow_run.actor.login}\n` +
                    `**Run URL:** ${context.payload.workflow_run.html_url}\n\n` +
                    `This is a critical failure that requires immediate attention. ` +
                    `Please review the workflow run and address the issues.\n\n` +
                    `---\n*Auto-generated by Honesty Framework Notification System*`,
              labels: ['critical', 'verification-failure', 'honesty-framework']
            });
            
            console.log(`Created issue #${issue.data.number}`);
            
      - name: Log notification
        run: |
          echo "ðŸ“‹ Logging notification event..."
          
          mkdir -p logs
          
          cat > logs/notification-$(date +%Y%m%d-%H%M%S).log << EOF
          Notification Event Log
          ======================
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: ${{ github.event.workflow_run.name }}
          Status: ${{ github.event.workflow_run.conclusion }}
          Severity: ${{ steps.severity.outputs.level }}
          Priority: ${{ steps.severity.outputs.priority }}
          Repository: ${{ github.repository }}
          Branch: ${{ github.event.workflow_run.head_branch }}
          Commit: ${{ github.event.workflow_run.head_sha }}
          Actor: ${{ github.event.workflow_run.actor.login }}
          Run URL: ${{ github.event.workflow_run.html_url }}
          EOF
          
          cat logs/notification-*.log
          
      - name: Upload notification logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notification-logs
          path: logs/
          retention-days: 90
          
  notify-on-success:
    name: Log Success Events
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Log success event
        run: |
          echo "âœ… Workflow completed successfully"
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"
          
          cat > success-log.txt << EOF
          Success Event Log
          =================
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Workflow: ${{ github.event.workflow_run.name }}
          Status: SUCCESS
          Repository: ${{ github.repository }}
          Branch: ${{ github.event.workflow_run.head_branch }}
          Commit: ${{ github.event.workflow_run.head_sha }}
          Actor: ${{ github.event.workflow_run.actor.login }}
          EOF
          
          cat success-log.txt
